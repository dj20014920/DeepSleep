import UIKit

// MARK: - ‚úÖ ÏùºÍ∏∞ ÏàòÏ†ï Ï†ÑÏö© Î∑∞ Ïª®Ìä∏Î°§Îü¨
class EditDiaryViewController: UIViewController {
    
    // MARK: - UI Components
    private let scrollView = UIScrollView()
    private let contentView = UIView()
    private let emotionSelectionView = UIView()
    private let textView = UITextView()
    
    // MARK: - Properties
    var diaryToEdit: EmotionDiary?
    var onDiaryUpdated: ((EmotionDiary) -> Void)?
    
    private var selectedEmotion: String = "üòä"
    private let emotions = ["üòä", "üò¢", "üò°", "üò∞", "üò¥", "ü•∞", "üòû", "üò§", "üò±", "üò™"]
    
    override func viewDidLoad() {
        super.viewDidLoad()
        setupUI()
        setupConstraints()
        loadDiaryData()
        setupKeyboardHandling()
    }
    
    private func setupUI() {
        view.backgroundColor = .systemBackground
        title = "ÏùºÍ∏∞ ÏàòÏ†ï"
        
        // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î∞î ÏÑ§Ï†ï
        navigationItem.leftBarButtonItem = UIBarButtonItem(
            barButtonSystemItem: .cancel,
            target: self,
            action: #selector(cancelTapped)
        )
        
        navigationItem.rightBarButtonItem = UIBarButtonItem(
            barButtonSystemItem: .save,
            target: self,
            action: #selector(saveTapped)
        )
        
        // Ïä§ÌÅ¨Î°§ Î∑∞ ÏÑ§Ï†ï
        scrollView.translatesAutoresizingMaskIntoConstraints = false
        contentView.translatesAutoresizingMaskIntoConstraints = false
        view.addSubview(scrollView)
        scrollView.addSubview(contentView)
        
        // Í∞êÏ†ï ÏÑ†ÌÉù Î∑∞ ÏÑ§Ï†ï
        setupEmotionSelection()
        
        // ÌÖçÏä§Ìä∏ Î∑∞ ÏÑ§Ï†ï
        textView.translatesAutoresizingMaskIntoConstraints = false
        textView.font = UIFont.systemFont(ofSize: 16)
        textView.layer.cornerRadius = 8
        textView.layer.borderWidth = 1
        textView.layer.borderColor = UIColor.systemGray4.cgColor
        textView.text = "Ïò§Îäò ÌïòÎ£®Îäî Ïñ¥Îï†ÎÇòÏöî? ÏûêÏú†Î°≠Í≤å Í∞êÏ†ïÏùÑ ÌëúÌòÑÌï¥Î≥¥ÏÑ∏Ïöî..."
        textView.textColor = .placeholderText
        textView.delegate = self
        contentView.addSubview(textView)
    }
    
    private func setupEmotionSelection() {
        emotionSelectionView.translatesAutoresizingMaskIntoConstraints = false
        contentView.addSubview(emotionSelectionView)
        
        let titleLabel = UILabel()
        titleLabel.text = "Ïò§ÎäòÏùò Í∏∞Î∂ÑÏùÄ Ïñ¥Îñ†ÏÑ∏Ïöî?"
        titleLabel.font = UIFont.systemFont(ofSize: 18, weight: .semibold)
        titleLabel.translatesAutoresizingMaskIntoConstraints = false
        emotionSelectionView.addSubview(titleLabel)
        
        let stackView = UIStackView()
        stackView.axis = .horizontal
        stackView.distribution = .fillEqually
        stackView.spacing = 8
        stackView.translatesAutoresizingMaskIntoConstraints = false
        emotionSelectionView.addSubview(stackView)
        
        for emotion in emotions {
            let button = UIButton(type: .system)
            button.setTitle(emotion, for: .normal)
            button.titleLabel?.font = UIFont.systemFont(ofSize: 28)
            button.layer.cornerRadius = 8
            button.backgroundColor = UIColor.systemGray6
            button.addTarget(self, action: #selector(emotionSelected(_:)), for: .touchUpInside)
            stackView.addArrangedSubview(button)
        }
        
        NSLayoutConstraint.activate([
            titleLabel.topAnchor.constraint(equalTo: emotionSelectionView.topAnchor),
            titleLabel.leadingAnchor.constraint(equalTo: emotionSelectionView.leadingAnchor),
            titleLabel.trailingAnchor.constraint(equalTo: emotionSelectionView.trailingAnchor),
            
            stackView.topAnchor.constraint(equalTo: titleLabel.bottomAnchor, constant: 12),
            stackView.leadingAnchor.constraint(equalTo: emotionSelectionView.leadingAnchor),
            stackView.trailingAnchor.constraint(equalTo: emotionSelectionView.trailingAnchor),
            stackView.bottomAnchor.constraint(equalTo: emotionSelectionView.bottomAnchor),
            stackView.heightAnchor.constraint(equalToConstant: 50)
        ])
    }
    
    private func setupConstraints() {
        NSLayoutConstraint.activate([
            // Ïä§ÌÅ¨Î°§ Î∑∞
            scrollView.topAnchor.constraint(equalTo: view.safeAreaLayoutGuide.topAnchor),
            scrollView.leadingAnchor.constraint(equalTo: view.leadingAnchor),
            scrollView.trailingAnchor.constraint(equalTo: view.trailingAnchor),
            scrollView.bottomAnchor.constraint(equalTo: view.bottomAnchor),
            
            // ÏΩòÌÖêÏ∏† Î∑∞
            contentView.topAnchor.constraint(equalTo: scrollView.topAnchor),
            contentView.leadingAnchor.constraint(equalTo: scrollView.leadingAnchor),
            contentView.trailingAnchor.constraint(equalTo: scrollView.trailingAnchor),
            contentView.bottomAnchor.constraint(equalTo: scrollView.bottomAnchor),
            contentView.widthAnchor.constraint(equalTo: scrollView.widthAnchor),
            
            // Í∞êÏ†ï ÏÑ†ÌÉù Î∑∞
            emotionSelectionView.topAnchor.constraint(equalTo: contentView.safeAreaLayoutGuide.topAnchor, constant: 20),
            emotionSelectionView.leadingAnchor.constraint(equalTo: contentView.leadingAnchor, constant: 20),
            emotionSelectionView.trailingAnchor.constraint(equalTo: contentView.trailingAnchor, constant: -20),
            
            // ÌÖçÏä§Ìä∏ Î∑∞
            textView.topAnchor.constraint(equalTo: emotionSelectionView.bottomAnchor, constant: 30),
            textView.leadingAnchor.constraint(equalTo: contentView.leadingAnchor, constant: 20),
            textView.trailingAnchor.constraint(equalTo: contentView.trailingAnchor, constant: -20),
            textView.heightAnchor.constraint(equalToConstant: 300),
            textView.bottomAnchor.constraint(equalTo: contentView.bottomAnchor, constant: -20)
        ])
    }
    
    private func setupKeyboardHandling() {
        NotificationCenter.default.addObserver(
            self,
            selector: #selector(keyboardWillShow),
            name: UIResponder.keyboardWillShowNotification,
            object: nil
        )
        
        NotificationCenter.default.addObserver(
            self,
            selector: #selector(keyboardWillHide),
            name: UIResponder.keyboardWillHideNotification,
            object: nil
        )
    }
    
    private func loadDiaryData() {
        guard let diary = diaryToEdit else { return }
        
        selectedEmotion = diary.selectedEmotion
        textView.text = diary.userMessage  // ‚úÖ userMessage ÏÇ¨Ïö©
        textView.textColor = .label
        
        // ÏÑ†ÌÉùÎêú Í∞êÏ†ï Î≤ÑÌäº Í∞ïÏ°∞ ÌëúÏãú
        updateEmotionSelection()
    }
    
    @objc private func emotionSelected(_ sender: UIButton) {
        guard let emotion = sender.titleLabel?.text else { return }
        selectedEmotion = emotion
        updateEmotionSelection()
    }
    
    private func updateEmotionSelection() {
        guard let stackView = emotionSelectionView.subviews.last as? UIStackView else { return }
        
        for view in stackView.arrangedSubviews {
            if let button = view as? UIButton {
                if button.titleLabel?.text == selectedEmotion {
                    button.backgroundColor = UIColor.systemBlue
                    button.setTitleColor(.white, for: .normal)
                } else {
                    button.backgroundColor = UIColor.systemGray6
                    button.setTitleColor(.label, for: .normal)
                }
            }
        }
    }
    
    @objc private func saveTapped() {
        guard let originalDiary = diaryToEdit,
              !textView.text.trimmingCharacters(in: .whitespacesAndNewlines).isEmpty,
              textView.textColor != .placeholderText else {
            showAlert(title: "‚ö†Ô∏è", message: "ÏùºÍ∏∞ ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.")
            return
        }
        
        // ‚úÖ ÏàòÏ†ïÎêú ÏùºÍ∏∞ ÏÉùÏÑ± - Ïò¨Î∞îÎ•∏ Ï¥àÍ∏∞Ìôî ÏÇ¨Ïö©
        let updatedDiary = EmotionDiary(
            id: originalDiary.id,
            selectedEmotion: selectedEmotion,
            userMessage: textView.text.trimmingCharacters(in: .whitespacesAndNewlines),
            aiResponse: originalDiary.aiResponse,  // Í∏∞Ï°¥ AI ÏùëÎãµ Ïú†ÏßÄ
            date: originalDiary.date
        )
        
        onDiaryUpdated?(updatedDiary)
        dismiss(animated: true)
    }
    
    @objc private func cancelTapped() {
        dismiss(animated: true)
    }
    
    @objc private func keyboardWillShow(notification: NSNotification) {
        guard let keyboardFrame = notification.userInfo?[UIResponder.keyboardFrameEndUserInfoKey] as? NSValue else { return }
        
        let keyboardHeight = keyboardFrame.cgRectValue.height
        let duration = notification.userInfo?[UIResponder.keyboardAnimationDurationUserInfoKey] as? Double ?? 0.3
        
        UIView.animate(withDuration: duration) {
            self.scrollView.contentInset.bottom = keyboardHeight
            self.scrollView.scrollIndicatorInsets.bottom = keyboardHeight
        }
    }
    
    @objc private func keyboardWillHide(notification: NSNotification) {
        let duration = notification.userInfo?[UIResponder.keyboardAnimationDurationUserInfoKey] as? Double ?? 0.3
        
        UIView.animate(withDuration: duration) {
            self.scrollView.contentInset.bottom = 0
            self.scrollView.scrollIndicatorInsets.bottom = 0
        }
    }
    
    private func showAlert(title: String, message: String) {
        let alert = UIAlertController(title: title, message: message, preferredStyle: .alert)
        alert.addAction(UIAlertAction(title: "ÌôïÏù∏", style: .default))
        present(alert, animated: true)
    }
    
    deinit {
        NotificationCenter.default.removeObserver(self)
    }
}

// MARK: - TextView Delegate
extension EditDiaryViewController: UITextViewDelegate {
    
    func textViewDidBeginEditing(_ textView: UITextView) {
        if textView.textColor == .placeholderText {
            textView.text = ""
            textView.textColor = .label
        }
    }
    
    func textViewDidEndEditing(_ textView: UITextView) {
        if textView.text.isEmpty {
            textView.text = "Ïò§Îäò ÌïòÎ£®Îäî Ïñ¥Îï†ÎÇòÏöî? ÏûêÏú†Î°≠Í≤å Í∞êÏ†ïÏùÑ ÌëúÌòÑÌï¥Î≥¥ÏÑ∏Ïöî..."
            textView.textColor = .placeholderText
        }
    }
}
