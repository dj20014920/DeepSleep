import UIKit

class FeedbackPromptViewController: UIViewController {
    
    // MARK: - Properties
    private var presetName: String
    private var recommendationType: RecommendationType
    private var onFeedbackProvided: ((Int) -> Void)?
    
    // UI Components
    private let containerView = UIView()
    private let iconImageView = UIImageView()
    private let titleLabel = UILabel()
    private let messageLabel = UILabel()
    private let benefitLabel = UILabel()
    private let buttonStackView = UIStackView()
    
    enum RecommendationType {
        case local
        case ai
        case comprehensive
        
        var displayName: String {
            switch self {
            case .local: return "Î°úÏª¨ AI Ï∂îÏ≤ú"
            case .ai: return "Ïô∏Î∂Ä AI Ï∂îÏ≤ú"
            case .comprehensive: return "Ï¢ÖÌï© AI Ï∂îÏ≤ú"
            }
        }
        
        var benefitMessage: String {
            switch self {
            case .local:
                return "üí° Ïù¥ ÌîºÎìúÎ∞±ÏùÄ Ïï± ÎÇ¥ Î°úÏª¨ AIÏùò ÌïôÏäµÏóê ÎèÑÏõÄÏù¥ Îê©ÎãàÎã§.\nÍ∞úÏù∏ÌôîÎêú Ï∂îÏ≤úÏù¥ ÎçîÏö± Ï†ïÌôïÌï¥Ï†∏Ïöî!"
            case .ai:
                return "üåê Ïù¥ ÌîºÎìúÎ∞±ÏùÄ Ïô∏Î∂Ä AI Î™®Îç∏Ïùò ÏÑ±Îä• Ìñ•ÏÉÅÏóê Í∏∞Ïó¨Ìï©ÎãàÎã§.\nÎçî ÎòëÎòëÌïú Ï∂îÏ≤úÏùÑ Î∞õÏúºÏã§ Ïàò ÏûàÏñ¥Ïöî!"
            case .comprehensive:
                return "üß† Ïù¥ ÌîºÎìúÎ∞±ÏùÄ Î°úÏª¨+Ïô∏Î∂Ä AI Î™®ÎëêÏóêÍ≤å ÎèÑÏõÄÏù¥ Îê©ÎãàÎã§.\nÏµúÍ≥†Ïùò Í∞úÏù∏Ìôî Í≤ΩÌóòÏùÑ ÎßåÎì§Ïñ¥ÎìúÎ†§Ïöî!"
            }
        }
    }
    
    // MARK: - Initialization
    init(presetName: String, recommendationType: RecommendationType, onFeedbackProvided: @escaping (Int) -> Void) {
        self.presetName = presetName
        self.recommendationType = recommendationType
        self.onFeedbackProvided = onFeedbackProvided
        super.init(nibName: nil, bundle: nil)
    }
    
    required init?(coder: NSCoder) {
        fatalError("init(coder:) has not been implemented")
    }
    
    // MARK: - Lifecycle
    override func viewDidLoad() {
        super.viewDidLoad()
        setupUI()
        setupLayout()
        animatePresentation()
    }
    
    // MARK: - UI Setup
    private func setupUI() {
        view.backgroundColor = UIColor.black.withAlphaComponent(0.5)
        
        // Container
        containerView.backgroundColor = UIDesignSystem.Colors.adaptiveBackground
        containerView.layer.cornerRadius = 16
        containerView.layer.shadowColor = UIColor.black.cgColor
        containerView.layer.shadowOffset = CGSize(width: 0, height: 4)
        containerView.layer.shadowOpacity = 0.3
        containerView.layer.shadowRadius = 8
        containerView.transform = CGAffineTransform(scaleX: 0.8, y: 0.8)
        containerView.alpha = 0
        
        // Icon
        iconImageView.image = UIImage(systemName: "heart.circle.fill")
        iconImageView.tintColor = UIColor.systemPink
        iconImageView.contentMode = .scaleAspectFit
        
        // Title
        titleLabel.text = "üéµ '\(presetName)'Îäî Ïñ¥Îñ†ÏÖ®ÎÇòÏöî?"
        titleLabel.font = UIFont.systemFont(ofSize: 18, weight: .semibold)
        titleLabel.textColor = UIDesignSystem.Colors.primaryText
        titleLabel.textAlignment = .center
        titleLabel.numberOfLines = 0
        
        // Message
        messageLabel.text = "ÏßßÏùÄ ÌîºÎìúÎ∞±ÏúºÎ°ú AIÍ∞Ä Îçî ÎòëÎòëÌï¥Ï†∏Ïöî"
        messageLabel.font = UIFont.systemFont(ofSize: 14, weight: .medium)
        messageLabel.textColor = UIDesignSystem.Colors.secondaryText
        messageLabel.textAlignment = .center
        
        // Benefit
        benefitLabel.text = recommendationType.benefitMessage
        benefitLabel.font = UIFont.systemFont(ofSize: 12, weight: .regular)
        benefitLabel.textColor = UIDesignSystem.Colors.primary
        benefitLabel.textAlignment = .center
        benefitLabel.numberOfLines = 0
        benefitLabel.backgroundColor = UIDesignSystem.Colors.primary.withAlphaComponent(0.1)
        benefitLabel.layer.cornerRadius = 8
        benefitLabel.layer.masksToBounds = true
        
        // Add padding to benefit label
        benefitLabel.layer.borderWidth = 1
        benefitLabel.layer.borderColor = UIDesignSystem.Colors.primary.withAlphaComponent(0.3).cgColor
        
        // Button Stack
        buttonStackView.axis = .horizontal
        buttonStackView.distribution = .fillEqually
        buttonStackView.spacing = 12
        
        // Create feedback buttons
        let loveButton = createFeedbackButton(
            title: "üòç Ï¢ãÏïÑÏöî",
            satisfaction: 2,
            backgroundColor: UIColor.systemGreen.withAlphaComponent(0.2),
            borderColor: UIColor.systemGreen
        )
        
        let okayButton = createFeedbackButton(
            title: "üòä Í∑∏ÎÉ• Í∑∏ÎûòÏöî",
            satisfaction: 1,
            backgroundColor: UIColor.systemOrange.withAlphaComponent(0.2),
            borderColor: UIColor.systemOrange
        )
        
        let mehButton = createFeedbackButton(
            title: "üòê Î≥ÑÎ°úÏòàÏöî",
            satisfaction: 0,
            backgroundColor: UIColor.systemRed.withAlphaComponent(0.2),
            borderColor: UIColor.systemRed
        )
        
        buttonStackView.addArrangedSubview(loveButton)
        buttonStackView.addArrangedSubview(okayButton)
        buttonStackView.addArrangedSubview(mehButton)
        
        // Skip button
        let skipButton = UIButton(type: .system)
        skipButton.setTitle("ÎÇòÏ§ëÏóê Ìï†Í≤åÏöî", for: .normal)
        skipButton.setTitleColor(UIDesignSystem.Colors.secondaryText, for: .normal)
        skipButton.titleLabel?.font = UIFont.systemFont(ofSize: 14, weight: .regular)
        skipButton.addTarget(self, action: #selector(skipButtonTapped), for: .touchUpInside)
        
        // Add all views
        view.addSubview(containerView)
        containerView.addSubview(iconImageView)
        containerView.addSubview(titleLabel)
        containerView.addSubview(messageLabel)
        containerView.addSubview(benefitLabel)
        containerView.addSubview(buttonStackView)
        containerView.addSubview(skipButton)
        
        // Configure constraints
        [containerView, iconImageView, titleLabel, messageLabel, benefitLabel, buttonStackView, skipButton].forEach {
            $0.translatesAutoresizingMaskIntoConstraints = false
        }
    }
    
    private func createFeedbackButton(title: String, satisfaction: Int, backgroundColor: UIColor, borderColor: UIColor) -> UIButton {
        let button = UIButton(type: .system)
        button.setTitle(title, for: .normal)
        button.setTitleColor(borderColor, for: .normal)
        button.titleLabel?.font = UIFont.systemFont(ofSize: 14, weight: .medium)
        button.backgroundColor = backgroundColor
        button.layer.cornerRadius = 8
        button.layer.borderWidth = 1.5
        button.layer.borderColor = borderColor.cgColor
        
        button.addTarget(self, action: #selector(feedbackButtonTapped(_:)), for: .touchUpInside)
        button.tag = satisfaction
        
        return button
    }
    
    private func setupLayout() {
        NSLayoutConstraint.activate([
            // Container
            containerView.centerXAnchor.constraint(equalTo: view.centerXAnchor),
            containerView.centerYAnchor.constraint(equalTo: view.centerYAnchor),
            containerView.leadingAnchor.constraint(greaterThanOrEqualTo: view.leadingAnchor, constant: 32),
            containerView.trailingAnchor.constraint(lessThanOrEqualTo: view.trailingAnchor, constant: -32),
            containerView.widthAnchor.constraint(lessThanOrEqualToConstant: 360),
            
            // Icon
            iconImageView.topAnchor.constraint(equalTo: containerView.topAnchor, constant: 24),
            iconImageView.centerXAnchor.constraint(equalTo: containerView.centerXAnchor),
            iconImageView.widthAnchor.constraint(equalToConstant: 40),
            iconImageView.heightAnchor.constraint(equalToConstant: 40),
            
            // Title
            titleLabel.topAnchor.constraint(equalTo: iconImageView.bottomAnchor, constant: 16),
            titleLabel.leadingAnchor.constraint(equalTo: containerView.leadingAnchor, constant: 20),
            titleLabel.trailingAnchor.constraint(equalTo: containerView.trailingAnchor, constant: -20),
            
            // Message
            messageLabel.topAnchor.constraint(equalTo: titleLabel.bottomAnchor, constant: 8),
            messageLabel.leadingAnchor.constraint(equalTo: containerView.leadingAnchor, constant: 20),
            messageLabel.trailingAnchor.constraint(equalTo: containerView.trailingAnchor, constant: -20),
            
            // Benefit
            benefitLabel.topAnchor.constraint(equalTo: messageLabel.bottomAnchor, constant: 16),
            benefitLabel.leadingAnchor.constraint(equalTo: containerView.leadingAnchor, constant: 20),
            benefitLabel.trailingAnchor.constraint(equalTo: containerView.trailingAnchor, constant: -20),
            
            // Button Stack
            buttonStackView.topAnchor.constraint(equalTo: benefitLabel.bottomAnchor, constant: 24),
            buttonStackView.leadingAnchor.constraint(equalTo: containerView.leadingAnchor, constant: 20),
            buttonStackView.trailingAnchor.constraint(equalTo: containerView.trailingAnchor, constant: -20),
            buttonStackView.heightAnchor.constraint(equalToConstant: 44),
            
            // Skip Button
            buttonStackView.bottomAnchor.constraint(equalTo: containerView.bottomAnchor, constant: -64),
        ])
        
        // Padding for benefit label - UILabelÏóêÎäî layoutMargins ÏßÅÏ†ë ÏÑ§Ï†ïÏù¥ Ï†úÌïúÏ†ÅÏù¥ÎØÄÎ°ú ÏàòÎèô Ìå®Îî© Ï†ÅÏö©
        // Ïù¥ÎØ∏ ÌÖçÏä§Ìä∏ ÏïûÎí§Î°ú Í≥µÎ∞±ÏùÑ Ï∂îÍ∞ÄÌïòÍ±∞ÎÇò constraintsÎ°ú Ìå®Îî© Ï≤òÎ¶¨
    }
    
    // MARK: - Animations
    private func animatePresentation() {
        UIView.animate(
            withDuration: 0.4,
            delay: 0.1,
            usingSpringWithDamping: 0.8,
            initialSpringVelocity: 0.2,
            options: [.curveEaseOut]
        ) {
            self.containerView.transform = .identity
            self.containerView.alpha = 1.0
        }
    }
    
    private func animateDismissal(completion: @escaping () -> Void) {
        UIView.animate(
            withDuration: 0.3,
            delay: 0,
            options: [.curveEaseIn]
        ) {
            self.containerView.transform = CGAffineTransform(scaleX: 0.8, y: 0.8)
            self.containerView.alpha = 0
            self.view.alpha = 0
        } completion: { _ in
            completion()
        }
    }
    
    // MARK: - Actions
    @objc private func feedbackButtonTapped(_ sender: UIButton) {
        let satisfaction = sender.tag
        
        // ÌñÖÌã± ÌîºÎìúÎ∞±
        let impactFeedback = UIImpactFeedbackGenerator(style: .medium)
        impactFeedback.impactOccurred()
        
        // Î≤ÑÌäº Ïï†ÎãàÎ©îÏù¥ÏÖò
        UIView.animate(withDuration: 0.1, animations: {
            sender.transform = CGAffineTransform(scaleX: 0.95, y: 0.95)
        }) { _ in
            UIView.animate(withDuration: 0.1) {
                sender.transform = .identity
            }
        }
        
        // Í∞êÏÇ¨ Î©îÏãúÏßÄ ÌëúÏãú ÌõÑ Ï¢ÖÎ£å
        showThankYouMessage(satisfaction: satisfaction)
    }
    
    @objc private func skipButtonTapped() {
        animateDismissal {
            self.dismiss(animated: false)
        }
    }
    
    private func showThankYouMessage(satisfaction: Int) {
        let thankYouMessages = [
            "üôè ÏÜåÏ§ëÌïú ÌîºÎìúÎ∞± Í∞êÏÇ¨Ìï¥Ïöî!\nAIÍ∞Ä Îçî ÎòëÎòëÌï¥Ï°åÏñ¥Ïöî.",
            "üíù ÌîºÎìúÎ∞± Í≥†ÎßàÏõåÏöî!\nÏïûÏúºÎ°ú Îçî ÎÇòÏùÄ Ï∂îÏ≤úÏùÑ ÎìúÎ¶¥Í≤åÏöî.",
            "‚ú® ÏùòÍ≤¨ Í∞êÏÇ¨Ìï©ÎãàÎã§!\nÍ∞úÏù∏Ìôî Ï∂îÏ≤úÏù¥ Ìñ•ÏÉÅÎêêÏñ¥Ïöî."
        ]
        
        let message = thankYouMessages.randomElement() ?? thankYouMessages[0]
        
        // UI ÏóÖÎç∞Ïù¥Ìä∏
        titleLabel.text = "Í∞êÏÇ¨Ìï©ÎãàÎã§! üéâ"
        messageLabel.text = message
        benefitLabel.isHidden = true
        buttonStackView.isHidden = true
        
        // ÌîºÎìúÎ∞± ÏΩúÎ∞± Ìò∏Ï∂ú
        onFeedbackProvided?(satisfaction)
        
        // 2Ï¥à ÌõÑ ÏûêÎèô Ï¢ÖÎ£å
        DispatchQueue.main.asyncAfter(deadline: .now() + 2.0) {
            self.animateDismissal {
                self.dismiss(animated: false)
            }
        }
    }
    
    // MARK: - Static Convenience Method
    static func present(
        from presentingViewController: UIViewController,
        presetName: String,
        recommendationType: RecommendationType,
        onFeedbackProvided: @escaping (Int) -> Void
    ) {
        let feedbackVC = FeedbackPromptViewController(
            presetName: presetName,
            recommendationType: recommendationType,
            onFeedbackProvided: onFeedbackProvided
        )
        
        feedbackVC.modalPresentationStyle = .overFullScreen
        feedbackVC.modalTransitionStyle = .crossDissolve
        
        presentingViewController.present(feedbackVC, animated: true)
    }
} 